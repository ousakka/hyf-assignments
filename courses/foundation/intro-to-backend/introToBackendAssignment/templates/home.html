<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>User API</title>
    <style>
      :root{--bg:#f6f9fc;--card:#fff;--accent:#2b6cb0;--muted:#6b7280}
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:0;padding:40px;background:linear-gradient(180deg,#eef2ff, #f8fafc);color:#0f172a}
      .container{max-width:760px;margin:0 auto}
      .card{background:var(--card);border-radius:12px;padding:28px;box-shadow:0 8px 24px rgba(2,6,23,0.08);text-align:center}
      h1{margin:0 0 8px;font-size:24px}
      .count{font-size:56px;font-weight:700;color:var(--accent);margin:8px 0}
      .subtitle{color:var(--muted);margin-bottom:18px}
      .controls{display:flex;gap:8px;justify-content:center;margin-bottom:16px}
      input[type='text']{padding:10px 12px;border-radius:8px;border:1px solid #e6e9ef;width:260px}
      button{background:var(--accent);color:#fff;padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
      button.secondary{background:#eef2ff;color:var(--accent)}
      ul{list-style:none;padding:0;margin:18px 0 0;text-align:left}
      li{padding:10px;border-bottom:1px solid #f1f5f9}
      .meta{color:var(--muted);font-size:13px}
      .empty{color:var(--muted);font-style:italic}
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h1>User API</h1>
        <div class="subtitle">A small UI to inspect the users database</div>

        <div>
          <div class="count" id="user-count">Loading...</div>
          <div class="meta">Total users in the database</div>
        </div>

        <div class="controls">
          <input id="search-input" type="text" placeholder="Search by name or email" />
          <button id="search-btn">Search</button>
          <button id="recent-btn" class="secondary">Recent 5</button>
        </div>

        <ul id="results"></ul>
      </div>
    </div>

    <script>
      async function fetchCount(){
        try{
          const r = await fetch('/user-count');
          const d = await r.json();
          if (d && d.error) {
            document.getElementById('user-count').textContent = '0';
            console.warn('user-count returned error:', d.error);
            return;
          }
          document.getElementById('user-count').textContent = d.total_users ?? '0';
        }catch(e){
          document.getElementById('user-count').textContent = 'Error';
          console.error(e);
        }
      }

      function renderUsers(list){
        const el = document.getElementById('results');
        el.innerHTML = '';
        if(!list || list.length===0){ el.innerHTML = '<li class="empty">No users found</li>'; return }
        for(const u of list){
          const li = document.createElement('li');
          li.innerHTML = `<strong>${u.first_name || ''} ${u.last_name || ''}</strong> <span class="meta">— ${u.email || '(no-email)'} • id=${u.id}</span> <div style="float:right"><button data-id="${u.id}" class="confirm-btn">Confirm</button></div>`;
          el.appendChild(li);
        }
        // attach confirm handlers
        for(const btn of document.querySelectorAll('.confirm-btn')){
          btn.addEventListener('click', async (ev)=>{
            const id = ev.target.dataset.id;
            try{
              const res = await fetch(`/users/${id}/confirm`, { method: 'POST' });
              if(!res.ok) throw new Error('Failed');
              fetchCount();
              ev.target.textContent = 'Confirmed';
              ev.target.disabled = true;
            }catch(e){
              console.error(e);
            }
          });
        }
      }

      document.getElementById('search-btn').addEventListener('click', async ()=>{
        const q = document.getElementById('search-input').value.trim();
        if(!q) return;
        const res = await fetch(`/search?q=${encodeURIComponent(q)}`);
        const data = await res.json();
        renderUsers(data);
      });

      document.getElementById('recent-btn').addEventListener('click', async ()=>{
        const res = await fetch('/recent-users?limit=5');
        const data = await res.json();
        renderUsers(data);
      });

      // initial load
      fetchCount();
    </script>
  </body>
</html>
